<!doctype html>
<html lang="ne">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Complete Data Entry Form</title>
  <style>
    :root{
      --primary:#0d6efd; --muted:#f4f8ff; --card:#fff; --shadow:rgba(0,0,0,0.08);
      --danger:#dc3545; --ok:#28a745;
    }
    body{font-family:Inter, Arial, Helvetica, sans-serif; background:linear-gradient(180deg,#eef9ff,#f8fbff); margin:0; padding:14px;}
    .wrap{max-width:1100px;margin:12px auto;padding:14px;}
    .card{background:var(--card); border-radius:12px; box-shadow:0 6px 20px var(--shadow); padding:14px; margin-bottom:14px;}
    h2{font-size:20px; margin:4px 0 12px; text-align:center; color:#023047;}

    .form-grid{display:grid; grid-template-columns: 1fr; gap:10px;}
    @media(min-width:980px){ .form-grid{ grid-template-columns: 1fr 1fr 1fr; gap:12px; } }

    .block{ background:var(--muted); padding:10px; border-radius:10px; }
    label{ display:block; font-weight:700; margin-bottom:6px; font-size:13px; color:#123; }
    input[type="text"], input[type="date"], input[type="tel"], select, textarea{
      width:100%; padding:9px 10px; border-radius:8px; border:1px solid #cfdce9; font-size:14px; box-sizing:border-box;
    }
    textarea{ min-height:64px; resize:vertical; }

    .radio-row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .radio-row label{ font-weight:600; font-size:14px; }

    .controls{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; align-items:center; }
    .btn{ border:0; padding:10px 12px; border-radius:8px; font-weight:700; cursor:pointer; background:var(--primary); color:#fff; }
    .btn.secondary{ background:#6c757d; }
    .btn.warn{ background:var(--danger); }
    .btn.small{ padding:8px 10px; font-size:13px; }
    .muted{ color:#666; font-size:13px; }

    .top-row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-bottom:10px; }
    .search-box{ display:flex; gap:8px; align-items:center; }
    .search-box input{ width:260px; padding:8px; border-radius:8px; border:1px solid #cfdce9; }

    .table-wrap{ overflow:auto; }
    table{ width:100%; border-collapse:collapse; font-size:14px; min-width:900px; }
    th, td{ padding:8px 10px; border:1px solid #e6eef9; text-align:left; vertical-align:middle; }
    th{ background:#eaf6ff; font-weight:700; font-size:13px; position:sticky; top:0; z-index:2; }
    td .meta{ font-size:12px; color:#666; }

    .pager{ display:flex; align-items:center; justify-content:center; gap:8px; margin-top:12px; flex-wrap:wrap; }

    #toast{ position:fixed; right:18px; bottom:18px; background:var(--ok); color:#fff; padding:12px 16px; border-radius:10px; transform:translateY(30px); opacity:0; transition:all .35s; z-index:9999; font-weight:700; }
    #toast.show{ transform:translateY(0); opacity:1; }

    .action-btn{ padding:6px 8px; border-radius:6px; border:0; cursor:pointer; font-weight:700; }
    .action-btn.edit{ background:#0d6efd; color:#fff; }
    .action-btn.del{ background:var(--danger); color:#fff; }

    .small-note{ font-size:13px; color:#444; margin-top:6px; }
    .flex-row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  </style>
</head>
<body>

    <!-- END HEADER -->
  <div class="wrap">
    <div class="card">
      <h2>ğ—ğ—”ğ—•ğ—˜ğ—šğ—¨ğ—›ğ—”ğ—¡ğ—š ğ— ğ—¨ğ—Ÿğ—§ğ—œ ğ—£ğ—¨ğ—¥ğ—£ğ—¢ğ—¦ğ—˜ ğ—–ğ—¢ğ— ğ—£ğ—”ğ—¬ ğ—Ÿğ˜ğ—±.</h2>
      <h2>ğ“’ğ“µğ“²ğ“·ğ“½ğ“¼ ğ“¡ğ“®ğ“¬ğ“¸ğ“»ğ“­ ğ“”ğ“·ğ“½ğ“»ğ”‚</h2>

      <div class="form-grid" id="formGrid">
        <!-- Column 1 -->
        <div class="block">
          <label for="datePickup">1. Date pickup</label>
          <input id="datePickup" type="date" />

          <label>2. Model</label>
          <div class="radio-row" id="modelRadios">
            <label><input type="radio" name="model" value="RE" checked> RE</label>
            <label><input type="radio" name="model" value="Maxima"> Maxima</label>
          </div>

          <label for="engineNo">3. Engine No</label>
          <input id="engineNo" type="text" placeholder="Engine Number" />

          <label for="frameNo">4. Frame No</label>
          <input id="frameNo" type="text" placeholder="Frame Number" />

          <label for="regNo">5. Registered No</label>
          <input id="regNo" type="text" placeholder="Registration Number" />
        </div>

        <!-- Column 2 -->
        <div class="block">
          <label for="batteryNo">6. Battery No</label>
          <input id="batteryNo" type="text" placeholder="Battery Number" />

          <label for="manuDate">7. Manufacturing Date</label>
          <input id="manuDate" type="date" />

          <label>8. Colour</label>
          <div class="radio-row" id="colourRadios">
            <label><input type="radio" name="colour" value="Blue" checked> BlueğŸ”µ</label>
            <label><input type="radio" name="colour" value="Red"> RedğŸ”´</label>
            <label><input type="radio" name="colour" value="Green">GreenğŸŸ¢</label>
          </div>

          <label for="financeSelect">9. Finance</label>
          <select id="financeSelect">
            <option value="Finance">Finance</option>
            <option value="Cash">Cash</option>
            <option value="Exchange">Exchange</option>
            <option value="Cash & Exchange">Cash & Exchange</option>
          </select>
        </div>

        <!-- Column 3 -->
        <div class="block">
          <label for="clientName">10. Name of clients</label>
          <input id="clientName" type="text" placeholder="Client Full Name" />

          <label for="address">11. Address</label>
          <input id="address" type="text" placeholder="Address" />

          <label for="contactNo">12. Contact No</label>
          <input id="contactNo" type="tel" placeholder="Phone Number" />

          <label for="salesPerson">13. Sales person</label>
          <input id="salesPerson" type="text" placeholder="Sales Person" />

          <label for="remarks">14. Remarks</label>
          <textarea id="remarks" placeholder="Remarks / Notes"></textarea>
        </div>
      </div>

      <div style="margin-top:10px;" class="card">
        <strong>15. Add Column (à¤¨à¤¯à¤¾à¤ à¤•à¥‰à¤²à¤® à¤¥à¤ªà¥à¤¨)</strong>
        <div style="margin-top:8px;" class="flex-row">
          <input id="newColName" type="text" placeholder="Column name (example: 'IMEI', 'ColorCode')" />
          <button id="addColBtn" class="btn small">ğŸ”—Add Column</button>
          <button id="resetCols" class="btn small secondary">âš ï¸Reset Custom Columns</button>
        </div>
        <div class="small-note">à¤¯à¤¹à¤¾à¤ à¤œà¥‹à¤¡à¤¿à¤à¤•à¤¾ à¤ªà¥à¤°à¤¤à¥à¤¯à¥‡à¤• à¤•à¤¸à¥à¤Ÿà¤® à¤•à¥‰à¤²à¤® à¤«à¤¾à¤°à¥à¤®à¤®à¤¾ à¤° à¤¤à¤¾à¤²à¤¿à¤•à¤¾à¤®à¤¾ à¤¥à¤ªà¤¿à¤¨à¥à¤› à¤° à¤¬à¥à¤°à¤¾à¤‰à¤œà¤°à¤®à¤¾ à¤¬à¤šà¤¾à¤‡à¤¨à¥à¤›à¥¤</div>
      </div>

      <div class="controls">
        <button id="saveBtn" class="btn">ğŸ’¾Save</button>
        <button id="clearBtn" class="btn secondary">ğŸ§¹Clear</button>

        <div style="flex:1"></div>

        <div class="muted">Records: <span id="totalCount">0</span></div>
      </div>
    </div>

    <!-- List / Search / Export -->
    <div class="card">
      <div class="top-row">
        <div class="search-box">
          <input id="searchInput" type="text" placeholder="Search â€” client / model / engine / frame / sales / custom..." />
          <button id="searchClear" class="btn small secondary">ğŸ§¹Clear</button>
        </div>

        <div style="display:flex; gap:8px; align-items:center;">
          <button id="exportCsv" class="btn small">ğŸ“Export CSV</button>
          <button id="exportPdf" class="btn small secondary">ğŸ’¾Export PDF</button>
          <button id="backupBtn" class="btn small">ğŸ‘©ğŸ½â€ğŸ’»Backup JSON</button>
          <button id="restoreBtn" class="btn small secondary">ğŸŸ¢Restore</button>
          <input id="restoreFile" type="file" accept="application/json" style="display:none" />
        </div>
      </div>

      <div class="table-wrap">
        <table id="recordTable" aria-live="polite">
          <thead id="tableHead">
            <tr id="theadRow">
              <!-- dynamic -->
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div class="pager">
        <button id="prevBtn" class="btn small secondary">â¬… Prev Page</button>
        <div class="info" id="pageInfo">Page 1 of 1</div>
        <button id="nextBtn" class="btn small secondary">Next Page â¡</button>
      </div>
    </div>
  </div>

  <div id="toast">Saved âœ“</div>

<script>
/*
  Complete single-file data entry system
  - dynamic custom columns
  - save / edit / delete / search / export / backup / restore / pagination
  - stores records and custom column definitions in localStorage
*/

// --- Config & state ---
const perPage = 10;
let currentPage = 1;
let editingId = null;
const RECORDS_KEY = 'de_records_v1';
const COLS_KEY = 'de_custom_cols_v1';

// base columns in order (these are also form field ids)
const baseCols = [
  { key: 'datePickup', label: 'Date Pickup' },
  { key: 'model', label: 'Model' },
  { key: 'engineNo', label: 'Engine No' },
  { key: 'frameNo', label: 'Frame No' },
  { key: 'regNo', label: 'Registered No' },
  { key: 'batteryNo', label: 'Battery No' },
  { key: 'manuDate', label: 'Manufacturing Date' },
  { key: 'colour', label: 'Colour' },
  { key: 'finance', label: 'Finance' },
  { key: 'clientName', label: "Client's Name" },
  { key: 'address', label: 'Address' },
  { key: 'contactNo', label: 'Contact No' },
  { key: 'salesPerson', label: 'Sales Person' },
  { key: 'remarks', label: 'Remarks' }
];

// DOM refs
const els = {
  // form fields
  datePickup: document.getElementById('datePickup'),
  modelRadios: document.getElementById('modelRadios'),
  engineNo: document.getElementById('engineNo'),
  frameNo: document.getElementById('frameNo'),
  regNo: document.getElementById('regNo'),
  batteryNo: document.getElementById('batteryNo'),
  manuDate: document.getElementById('manuDate'),
  colourRadios: document.getElementById('colourRadios'),
  financeSelect: document.getElementById('financeSelect'),
  clientName: document.getElementById('clientName'),
  address: document.getElementById('address'),
  contactNo: document.getElementById('contactNo'),
  salesPerson: document.getElementById('salesPerson'),
  remarks: document.getElementById('remarks'),
  newColName: document.getElementById('newColName'),
  addColBtn: document.getElementById('addColBtn'),
  resetCols: document.getElementById('resetCols'),

  saveBtn: document.getElementById('saveBtn'),
  clearBtn: document.getElementById('clearBtn'),
  totalCount: document.getElementById('totalCount'),

  searchInput: document.getElementById('searchInput'),
  searchClear: document.getElementById('searchClear'),
  exportCsv: document.getElementById('exportCsv'),
  exportPdf: document.getElementById('exportPdf'),
  backupBtn: document.getElementById('backupBtn'),
  restoreBtn: document.getElementById('restoreBtn'),
  restoreFile: document.getElementById('restoreFile'),

  tableHead: document.getElementById('tableHead'),
  theadRow: document.getElementById('theadRow'),
  tableBody: document.getElementById('tableBody'),
  prevBtn: document.getElementById('prevBtn'),
  nextBtn: document.getElementById('nextBtn'),
  pageInfo: document.getElementById('pageInfo'),

  toast: document.getElementById('toast')
};

// helpers for radio values
function getRadioValue(name){ const r = document.querySelector(`input[name="${name}"]:checked`); return r ? r.value : ''; }
function setRadioValue(name, val){ const r = document.querySelectorAll(`input[name="${name}"]`); r.forEach(i => i.checked = (i.value === val)); }

// storage helpers
function getRecords(){ try { return JSON.parse(localStorage.getItem(RECORDS_KEY) || '[]'); } catch(e){ return []; } }
function setRecords(arr){
  // ensure each has _id and savedAt
  const normalized = (arr || []).map(r => {
    if(!r._id) r._id = 'id_'+Date.now()+'_'+Math.floor(Math.random()*9999);
    if(!r.savedAt) r.savedAt = Date.now();
    return r;
  });
  // sort by savedAt desc
  normalized.sort((a,b)=> (b.savedAt||0) - (a.savedAt||0));
  localStorage.setItem(RECORDS_KEY, JSON.stringify(normalized));
}

function getCustomCols(){ try { return JSON.parse(localStorage.getItem(COLS_KEY) || '[]'); } catch(e){ return []; } }
function setCustomCols(cols){ localStorage.setItem(COLS_KEY, JSON.stringify(cols || [])); }

// id gen
function genId(){ return 'id_'+Date.now()+'_'+Math.floor(Math.random()*9999); }

// toast
function showToast(msg='Saved âœ“'){ els.toast.textContent = msg; els.toast.classList.add('show'); setTimeout(()=> els.toast.classList.remove('show'),1800); }

// build current columns (base + custom)
function allColumns(){ return baseCols.concat(getCustomCols()); }

// render table head based on current columns
function renderTableHead(){
  const cols = allColumns();
  els.theadRow.innerHTML = '';
  for(const c of cols){
    const th = document.createElement('th');
    th.textContent = c.label;
    els.theadRow.appendChild(th);
  }
  // actions column
  const thAct = document.createElement('th');
  thAct.textContent = 'Actions';
  thAct.style.width = '150px';
  els.theadRow.appendChild(thAct);
}

// clear form
function clearForm(){
  editingId = null;
  els.datePickup.value = '';
  setRadioValue('model', 'RE');
  els.engineNo.value = '';
  els.frameNo.value = '';
  els.regNo.value = '';
  els.batteryNo.value = '';
  els.manuDate.value = '';
  setRadioValue('colour', 'Blue');
  els.financeSelect.value = 'Finance';
  els.clientName.value = '';
  els.address.value = '';
  els.contactNo.value = '';
  els.salesPerson.value = '';
  els.remarks.value = '';
  // clear custom field inputs if present
  const customs = getCustomCols();
  for(const c of customs){
    const el = document.getElementById('fld_'+c.key);
    if(el) el.value = '';
  }
  els.saveBtn.textContent = 'Save';
  els.saveBtn.classList.remove('warn');
}

// fill form for edit
function fillFormForEdit(rec){
  editingId = rec._id;
  els.datePickup.value = rec.datePickup || '';
  setRadioValue('model', rec.model || 'RE');
  els.engineNo.value = rec.engineNo || '';
  els.frameNo.value = rec.frameNo || '';
  els.regNo.value = rec.regNo || '';
  els.batteryNo.value = rec.batteryNo || '';
  els.manuDate.value = rec.manuDate || '';
  setRadioValue('colour', rec.colour || 'Blue');
  els.financeSelect.value = rec.finance || 'Finance';
  els.clientName.value = rec.clientName || '';
  els.address.value = rec.address || '';
  els.contactNo.value = rec.contactNo || '';
  els.salesPerson.value = rec.salesPerson || '';
  els.remarks.value = rec.remarks || '';
  // custom fields
  const customs = getCustomCols();
  for(const c of customs){
    const el = document.getElementById('fld_'+c.key);
    if(el) el.value = rec[c.key] || '';
  }
  els.saveBtn.textContent = 'Update';
  els.saveBtn.classList.add('warn');
  window.scrollTo({top:0, behavior:'smooth'});
}

// collect form payload
function collectForm(){
  const payload = {};
  payload._id = editingId || genId();
  payload.savedAt = Date.now();
  payload.datePickup = els.datePickup.value;
  payload.model = getRadioValue('model');
  payload.engineNo = els.engineNo.value.trim();
  payload.frameNo = els.frameNo.value.trim();
  payload.regNo = els.regNo.value.trim();
  payload.batteryNo = els.batteryNo.value.trim();
  payload.manuDate = els.manuDate.value;
  payload.colour = getRadioValue('colour');
  payload.finance = els.financeSelect.value;
  payload.clientName = els.clientName.value.trim();
  payload.address = els.address.value.trim();
  payload.contactNo = els.contactNo.value.trim();
  payload.salesPerson = els.salesPerson.value.trim();
  payload.remarks = els.remarks.value.trim();

  // add custom fields
  const customs = getCustomCols();
  for(const c of customs){
    const el = document.getElementById('fld_'+c.key);
    payload[c.key] = el ? el.value.trim() : '';
  }

  return payload;
}

// save / update handler
els.saveBtn.addEventListener('click', ()=>{
  const payload = collectForm();
  // basic validation â€” require clientName and model (you can adjust)
  if(!payload.clientName){
    alert('Client name à¤°à¤¾à¤–à¥à¤¨à¥à¤¸à¥ (Name of clients required).');
    return;
  }
  let arr = getRecords();
  if(editingId){
    const idx = arr.findIndex(r=> r._id === editingId);
    if(idx !== -1){
      arr[idx] = payload;
      setRecords(arr);
      showToast('Updated âœ“');
    } else {
      // fallback: push
      arr.push(payload); setRecords(arr); showToast('Saved âœ“');
    }
  } else {
    arr.push(payload);
    setRecords(arr);
    showToast('Saved âœ“');
  }
  clearForm();
  currentPage = 1; render();
});

// delete record
function deleteRecord(id){
  if(!confirm('âš ï¸ğ–ğšğ«ğ§ğ¢ğ§ğ : à¤•à¥‡ à¤¯à¥‹ à¤°à¥‡à¤•à¤°à¥à¤¡ à¤®à¥‡à¤Ÿà¤¾à¤‰à¤¨ à¤¨à¤¿à¤¶à¥à¤šà¤¿à¤¤ à¤¹à¥à¤¨à¥à¤¹à¥à¤¨à¥à¤›?')) return;
  let arr = getRecords();
  arr = arr.filter(r=> r._id !== id);
  setRecords(arr);
  // adjust page if needed
  const totalPages = Math.max(1, Math.ceil(filteredRecords().length / perPage));
  if(currentPage > totalPages) currentPage = totalPages;
  render();
  showToast('Deleted âœ“');
}

// edit
function editRecord(id){
  const arr = getRecords();
  const rec = arr.find(r=> r._id === id);
  if(rec) fillFormForEdit(rec);
}

// search / filter
function filteredRecords(){
  const q = els.searchInput.value.trim().toLowerCase();
  const arr = getRecords().slice().sort((a,b)=> (b.savedAt||0) - (a.savedAt||0));
  if(!q) return arr;
  return arr.filter(r=>{
    // search in base + custom fields
    const allCols = allColumns();
    for(const c of allCols){
      const val = String(r[c.key]||'').toLowerCase();
      if(val.includes(q)) return true;
    }
    return false;
  });
}

// render table rows with pagination
function render(){
  renderTableHead();
  const all = filteredRecords();
  const total = all.length;
  const totalPages = Math.max(1, Math.ceil(total / perPage));
  if(currentPage > totalPages) currentPage = totalPages;
  const start = (currentPage - 1) * perPage;
  const pageRecs = all.slice(start, start + perPage);

  els.tableBody.innerHTML = '';
  if(pageRecs.length === 0){
    els.tableBody.innerHTML = `<tr><td colspan="${allColumns().length + 1}" style="text-align:center;padding:18px;">No records found</td></tr>`;
  } else {
    for(const r of pageRecs){
      const tr = document.createElement('tr');
      const cells = [];
      for(const c of allColumns()){
        const td = document.createElement('td');
        let v = r[c.key] || '';
        // format dates to readable when possible
        if((c.key === 'datePickup' || c.key === 'manuDate') && v){
          try { v = new Date(v).toLocaleDateString(); } catch(e){ }
        }
        td.innerHTML = `<div style="font-weight:600">${escapeHtml(String(v))}</div>`;
        tr.appendChild(td);
      }
      // actions
      const tdAct = document.createElement('td');
      tdAct.innerHTML = `
        <button class="action-btn edit" onclick="window.__de_edit('${r._id}')">Edit</button>
        <button class="action-btn del" onclick="window.__de_del('${r._id}')">Delete</button>
        <div class="meta">${new Date(r.savedAt).toLocaleString()}</div>
      `;
      tr.appendChild(tdAct);
      els.tableBody.appendChild(tr);
    }
  }

  els.pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
  els.prevBtn.disabled = currentPage === 1;
  els.nextBtn.disabled = currentPage === totalPages;
  els.totalCount.textContent = total;
}

// expose functions for inline onclick
window.__de_edit = editRecord;
window.__de_del = deleteRecord;

// prev / next
els.prevBtn.addEventListener('click', ()=>{ if(currentPage>1) currentPage--; render(); });
els.nextBtn.addEventListener('click', ()=>{ const totalPages = Math.max(1, Math.ceil(filteredRecords().length / perPage)); if(currentPage<totalPages) currentPage++; render(); });

// search
els.searchInput.addEventListener('input', ()=>{ currentPage = 1; render(); });
els.searchClear.addEventListener('click', ()=>{ els.searchInput.value = ''; currentPage = 1; render(); });

// CSV export (export filtered full set)
els.exportCsv.addEventListener('click', ()=>{
  const arr = filteredRecords();
  if(arr.length === 0){ alert('Export à¤—à¤°à¥à¤¨ à¤•à¥‹ à¤²à¤¾à¤—à¥€ à¤•à¥à¤¨à¥ˆ à¤°à¤¿à¤•à¥‰à¤°à¥à¤¡ à¤›à¥ˆà¤¨'); return; }
  const cols = allColumns();
  const headers = cols.map(c => csvSafe(c.label));
  const rows = arr.map(r => cols.map(c => csvSafe(r[c.key] || '')));
  const csv = [headers.join(','), ...rows.map(r=> r.join(','))].join('\n');
  downloadBlob(csv, `records_${(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`, 'text/csv;charset=utf-8;');
});

// PDF export (open printable HTML)
els.exportPdf.addEventListener('click', ()=>{
  const arr = filteredRecords();
  if(arr.length === 0){ alert('Export à¤—à¤°à¥à¤¨ à¤•à¥‹ à¤²à¤¾à¤—à¥€ à¤•à¥à¤¨à¥ˆ à¤°à¤¿à¤•à¥‰à¤°à¥à¤¡ à¤›à¥ˆà¤¨'); return; }
  const cols = allColumns();
  let html = `<html><head><meta charset="utf-8"><title>Records</title>
    <style>body{font-family:Arial;padding:12px;}table{width:100%;border-collapse:collapse;font-size:12px}th,td{border:1px solid #ddd;padding:6px;text-align:left}th{background:#f0f8ff}</style>
    </head><body><h3>Exported Records (${arr.length})</h3><table><thead><tr>`;
  for(const c of cols) html += `<th>${escapeHtml(c.label)}</th>`;
  html += `</tr></thead><tbody>`;
  arr.forEach(r=>{
    html += `<tr>`;
    for(const c of cols){
      let v = r[c.key] || '';
      if((c.key === 'datePickup' || c.key === 'manuDate') && v){
        try { v = new Date(v).toLocaleDateString(); } catch(e){}
      }
      html += `<td>${escapeHtml(String(v))}</td>`;
    }
    html += `</tr>`;
  });
  html += `</tbody></table></body></html>`;
  const w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
  setTimeout(()=> w.print(), 600);
});

// backup (download JSON)
els.backupBtn.addEventListener('click', ()=>{
  const arr = getRecords();
  const json = JSON.stringify({ records: arr, customCols: getCustomCols() }, null, 2);
  downloadBlob(json, `records_backup_${(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`, 'application/json');
  showToast('Backup ready âœ“');
});

// restore
els.restoreBtn.addEventListener('click', ()=>{
  els.restoreFile.value = '';
  els.restoreFile.click();
});
els.restoreFile.addEventListener('change', (ev)=>{
  const f = ev.target.files && ev.target.files[0];
  if(!f) return;
  if(!confirm('à¤ªà¤•à¥à¤•à¤¾? Restore à¤—à¤°à¥à¤¦à¤¾ à¤¹à¤¾à¤²à¤•à¥‹ à¤¸à¥à¤¥à¤¾à¤¨à¥€à¤¯ à¤¡à¥‡à¤Ÿà¤¾ overwrite à¤¹à¥à¤¨à¥‡à¤›à¥¤ Proceed à¤—à¤°à¥à¤¨à¥à¤¹à¥à¤¨à¥à¤›?')) return;
  const reader = new FileReader();
  reader.onload = function(e){
    try {
      const data = JSON.parse(e.target.result);
      // support both array and object {records, customCols}
      let recs = [];
      let cols = [];
      if(Array.isArray(data)) recs = data;
      else {
        recs = Array.isArray(data.records) ? data.records : [];
        cols = Array.isArray(data.customCols) ? data.customCols : (Array.isArray(data.customColumns) ? data.customColumns : []);
      }
      // normalize recs
      recs = recs.map(r => {
        const rec = Object.assign({}, r);
        if(!rec._id) rec._id = genId();
        if(!rec.savedAt) rec.savedAt = Date.now();
        return rec;
      });
      setRecords(recs);
      // normalize cols (must be objects with key+label)
      cols = cols.map((c, idx) => {
        if(typeof c === 'string') return { key: 'custom_'+idx+'_'+slugify(c), label: c };
        if(c.key && c.label) return c;
        // fallback
        return { key: c.key || ('custom_'+idx+'_'+slugify(c.label||'col')), label: c.label || ('Column '+(idx+1)) };
      });
      setCustomCols(cols);
      currentPage = 1; render(); showToast('Restore à¤¸à¤«à¤² âœ“');
    } catch(err){
      alert('Restore à¤µà¤¿à¤«à¤²: ' + err.message);
    }
  };
  reader.readAsText(f);
});

// download helper
function downloadBlob(content, filename, type){
  const blob = new Blob([content], { type: type || 'application/octet-stream' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

// CSV safe
function csvSafe(v){
  if(v == null) return '""';
  const s = String(v).replace(/"/g, '""');
  return `"${s}"`;
}

// escape HTML
function escapeHtml(str){
  if(str == null) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// --- Custom columns handling ---
// custom columns stored as array of objects: { key: 'custom_1_xxx', label: 'IMEI' }
function slugify(txt){ return String(txt || '').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }

function renderCustomFieldsArea(){
  // ensure each custom col also has an input in the form
  const customs = getCustomCols();
  // We'll append custom fields after the third block (end of form)
  // find the form grid
  const formGrid = document.getElementById('formGrid');
  // Remove any existing custom-field-block
  const existing = document.getElementById('customBlock');
  if(existing) existing.remove();
  if(customs.length === 0) return;
  const div = document.createElement('div');
  div.className = 'block';
  div.id = 'customBlock';
  // build inputs
  for(const c of customs){
    const label = document.createElement('label');
    label.textContent = c.label;
    const input = document.createElement('input');
    input.type = 'text';
    input.id = 'fld_' + c.key;
    input.placeholder = c.label;
    input.style.marginBottom = '8px';
    div.appendChild(label);
    div.appendChild(input);
  }
  formGrid.appendChild(div);
}

// add custom column
els.addColBtn.addEventListener('click', ()=>{
  const name = els.newColName.value.trim();
  if(!name){ alert('à¤•à¥ƒà¤ªà¤¯à¤¾ column name à¤²à¥‡à¤–à¥à¤¨à¥à¤¸à¥'); return; }
  const customs = getCustomCols();
  // check duplicates by label
  if(customs.some(c => c.label.toLowerCase() === name.toLowerCase())){
    alert('à¤¯à¥‹ à¤¨à¤¾à¤®à¤²à¥‡ à¤ªà¤¹à¤¿à¤²à¥‡ à¤¨à¥ˆ column à¤›à¥¤');
    return;
  }
  // create key
  const key = 'custom_' + Date.now() + '_' + slugify(name);
  customs.push({ key, label: name });
  setCustomCols(customs);
  els.newColName.value = '';
  renderCustomFieldsArea();
  render(); // re-render table with new column
  showToast('Column à¤¥à¤ªà¤¿à¤¯à¥‹ âœ“');
});

// reset custom columns
els.resetCols.addEventListener('click', ()=>{
  if(!confirm('à¤¸à¤¾à¤šà¥à¤šà¥ˆ à¤¸à¤¬à¥ˆ custom columns à¤¹à¤Ÿà¤¾à¤‰à¤¨ à¤šà¤¾à¤¹à¤¨à¥à¤¹à¥à¤¨à¥à¤›?')) return;
  setCustomCols([]);
  // optionally remove custom values from records? We'll leave existing values but columns won't show.
  renderCustomFieldsArea();
  render();
  showToast('Custom columns à¤¹à¤Ÿà¤¾à¤‡à¤¯à¥‹ âœ“');
});

// --- Init ---
// create table head initially and custom fields area
renderCustomFieldsArea();
renderTableHead();
render();

// add custom fields inputs to DOM (call after rendering custom cols)
renderCustomFieldsArea();

// attach clear
els.clearBtn.addEventListener('click', clearForm);

// handle storage event from other tabs
window.addEventListener('storage', (e)=>{
  if(e.key === RECORDS_KEY || e.key === COLS_KEY) render();
});

// initial render call (in case)
render();
</script>
</body>
</html>
